# 后端环境与依赖安装

## 快速开始（一键推荐·Windows）

- 初始化（创建/激活 venv、安装依赖、迁移数据库）：
```
powershell -ExecutionPolicy Bypass -File .\scripts\setup.ps1 -UseMirror
```
- 启动开发服务（会自动激活 venv）：
```
powershell -ExecutionPolicy Bypass -File .\scripts\run.ps1
```

> 若直接运行 `python manage.py runserver`，请先激活虚拟环境：`.\n.venv\Scripts\Activate.ps1`，否则可能出现“找不到依赖”的错误。

## 使用 venv + requirements.txt（推荐）

1. 创建并激活虚拟环境

- Windows PowerShell:

```
python -m venv .venv
.\.venv\Scripts\Activate.ps1
```

- macOS/Linux:

```
python3 -m venv .venv
source .venv/bin/activate
```

2. 安装依赖（使用项目根目录的 requirements.txt）

```
pip install -r requirements.txt
```

- 可选：国内镜像示例

```
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

## 使用 Conda（可选方案）

```
conda create --name myprojectenv python=3.8
conda activate myprojectenv
pip install -r requirements.txt
```

## 一键脚本（Windows）

- 初始化环境并迁移数据库：
```
powershell -ExecutionPolicy Bypass -File .\scripts\setup.ps1
```
- 使用清华镜像（可选）：
```
powershell -ExecutionPolicy Bypass -File .\scripts\setup.ps1 -UseMirror
```
- 启动开发服务：
```
powershell -ExecutionPolicy Bypass -File .\scripts\run.ps1
```

## 开发与运行

1. 迁移数据库（如首次运行）

```
python manage.py migrate
```

2. 启动 Django 项目

```
python manage.py runserver
```

## 环境变量概览（.env）

- 基础：`SECRET_KEY`, `DEBUG`, `ALLOWED_HOSTS`
- 数据库：`DATABASE_URL`（默认 `sqlite:///data/db.sqlite3`）
- CORS：`CORS_ALLOW_ALL_ORIGINS` 或 `CORS_ALLOWED_ORIGINS`
- JWT：`JWT_ACCESS_MINUTES`, `JWT_REFRESH_DAYS`, `JWT_SIGNING_KEY`
- Mongo：`MONGO_URL`, `MONGO_DB_NAME`
- XtQuant：`XT_USERDATA_PATH`, `XT_API_KEY`, `XT_SECRET_KEY`, `XT_TOKEN`, `XT_ADDR_LIST`, `XT_PORT`
- 日志：`LOG_LEVEL`, `LOG_FILE`

> 建议在本地复制 `env/env_example.txt` 为 `.env`，生产基于 `env/env_production_example.txt`。

## 常见问题

- 如果 Windows PowerShell 无法执行激活脚本，可临时放宽执行策略（管理员 PowerShell）：

```
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

- 若端口占用，修改启动命令：

```
python manage.py runserver 0.0.0.0:8001
```
