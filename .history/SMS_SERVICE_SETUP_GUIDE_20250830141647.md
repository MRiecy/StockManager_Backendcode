# 短信服务配置指南

## 概述
本指南将帮助您配置真实的短信服务，替换开发环境中的模拟短信服务。

## 支持的短信服务提供商

### 1. 阿里云短信服务（推荐）
- **优势**: 稳定性高、价格合理、文档完善
- **适用场景**: 国内短信发送
- **价格**: 约0.045元/条

### 2. 腾讯云短信服务
- **优势**: 与腾讯生态集成好、安全性高
- **适用场景**: 国内短信发送
- **价格**: 约0.045元/条

### 3. 模拟短信服务
- **用途**: 开发环境测试
- **特点**: 不发送真实短信，仅打印到控制台

## 配置步骤

### 步骤1: 创建环境配置文件

复制 `env_example.txt` 为 `.env` 文件：

```bash
cp env_example.txt .env
```

### 步骤2: 配置阿里云短信服务

#### 2.1 注册阿里云账户
1. 访问 [阿里云官网](https://www.aliyun.com/)
2. 注册账户并完成实名认证
3. 开通短信服务

#### 2.2 获取访问密钥
1. 登录阿里云控制台
2. 进入"访问控制" → "用户" → "创建用户"
3. 选择"编程访问"，获取 AccessKey ID 和 AccessKey Secret
4. 为用户分配短信服务权限

#### 2.3 创建短信签名
1. 进入"短信服务" → "国内消息" → "签名管理"
2. 点击"添加签名"
3. 填写签名信息：
   - 签名名称：如"股票管理系统"
   - 签名来源：选择"企业全称"
   - 签名用途：选择"通用"
4. 上传相关证明材料
5. 等待审核通过

#### 2.4 创建短信模板
1. 进入"模板管理" → "添加模板"
2. 选择"验证码"类型
3. 填写模板内容，例如：
   ```
   您的验证码是：${code}，5分钟内有效，请勿泄露给他人。
   ```
4. 等待审核通过

#### 2.5 配置环境变量
在 `.env` 文件中配置：

```bash
# 短信服务选择
SMS_PROVIDER=aliyun

# 阿里云配置
ALIYUN_ACCESS_KEY_ID=your_access_key_id_here
ALIYUN_ACCESS_KEY_SECRET=your_access_key_secret_here
ALIYUN_SMS_SIGN_NAME=股票管理系统
ALIYUN_SMS_TEMPLATE_CODE=SMS_123456789
```

### 步骤3: 配置腾讯云短信服务（备选）

#### 3.1 注册腾讯云账户
1. 访问 [腾讯云官网](https://cloud.tencent.com/)
2. 注册账户并完成实名认证
3. 开通短信服务

#### 3.2 获取密钥信息
1. 登录腾讯云控制台
2. 进入"访问管理" → "API密钥管理"
3. 创建新的密钥，获取 SecretId 和 SecretKey

#### 3.3 创建短信应用
1. 进入"短信服务" → "应用管理"
2. 创建新应用，获取 SDK AppID

#### 3.4 创建短信签名和模板
1. 创建短信签名（如"股票管理系统"）
2. 创建验证码模板
3. 记录签名名称和模板ID

#### 3.5 配置环境变量
在 `.env` 文件中配置：

```bash
# 短信服务选择
SMS_PROVIDER=tencent

# 腾讯云配置
TENCENT_SECRET_ID=your_secret_id_here
TENCENT_SECRET_KEY=your_secret_key_here
TENCENT_SMS_SDK_APP_ID=your_sdk_app_id_here
TENCENT_SMS_SIGN_NAME=股票管理系统
TENCENT_SMS_TEMPLATE_ID=your_template_id_here
```

## 测试配置

### 方法1: 使用Django管理命令

```bash
# 测试短信服务
python manage.py test_sms 13888888888

# 指定验证码
python manage.py test_sms 13888888888 --code 888888

# 指定服务提供商
python manage.py test_sms 13888888888 --provider aliyun
```

### 方法2: 使用API接口

```bash
# 获取短信服务状态
curl http://localhost:8000/api/sms/status/

# 发送验证码
curl -X POST http://localhost:8000/api/auth/send-code/ \
  -H "Content-Type: application/json" \
  -d '{"phone": "13888888888"}'
```

### 方法3: 使用测试脚本

```bash
python test_auth_api.py
```

## 常见问题

### Q1: 短信发送失败，提示"签名不存在"
**A**: 检查签名名称是否正确，确保签名已审核通过。

### Q2: 短信发送失败，提示"模板不存在"
**A**: 检查模板代码/ID是否正确，确保模板已审核通过。

### Q3: 短信发送失败，提示"余额不足"
**A**: 充值阿里云/腾讯云账户余额。

### Q4: 短信发送失败，提示"权限不足"
**A**: 检查AccessKey是否有短信服务权限，或重新创建用户并分配权限。

### Q5: 开发环境如何快速测试？
**A**: 设置 `SMS_PROVIDER=mock`，系统会使用模拟短信服务，不会发送真实短信。

## 安全注意事项

1. **保护密钥**: 不要将AccessKey等敏感信息提交到代码仓库
2. **环境隔离**: 生产环境和开发环境使用不同的密钥
3. **权限最小化**: 只给必要的权限，不要使用主账户的密钥
4. **监控告警**: 设置短信发送失败告警，及时发现问题

## 成本控制

1. **测试环境**: 使用模拟短信服务，避免测试成本
2. **频率限制**: 系统已内置1分钟发送频率限制
3. **批量发送**: 避免频繁发送测试短信
4. **余额监控**: 定期检查账户余额，避免欠费

## 生产环境部署

1. **环境变量**: 确保生产环境正确配置环境变量
2. **日志记录**: 开启短信发送日志，便于问题排查
3. **监控告警**: 集成监控系统，监控短信发送成功率
4. **备份方案**: 配置多个短信服务提供商作为备份

## 联系支持

- **阿里云**: [短信服务文档](https://help.aliyun.com/product/44282.html)
- **腾讯云**: [短信服务文档](https://cloud.tencent.com/document/product/382)
- **项目支持**: 如有问题，请查看项目Issues或联系开发团队 